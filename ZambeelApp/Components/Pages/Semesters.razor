@page "/enroll/{StudentId:int}/semesters"
@using ZambeelApp.Services
@using ZambeelApp.Models
@inject IZambeelService SP_Service
@inject Service_LINQ LINQ_Service
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2> Choose Your Semester</h2>
                <button class="btn btn-secondary" @onclick="GoBack">‚Üê Back to Enrollment</button>
            </div>
        </div>
    </div>

    <div class="alert alert-info">
        <label>
            <input type="checkbox" @bind="useLinq" /> 
            <strong>Use LINQ Implementation?</strong> (Current: @(useLinq ? "LINQ" : "Stored Procedures"))
        </label>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5>Your Semesters</h5>
                </div>
                <div class="card-body">
                    @if (semesters != null && semesters.Any())
                    {
                        <div class="list-group">
                            @foreach (var semester in semesters)
                            {
                                <button class="list-group-item list-group-item-action text-start @(selectedSemester == semester ? "active" : "")" 
                                        @onclick="@(() => SelectSemester(semester))">
                                    <h6 class="mb-0">@semester</h6>
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">No semesters found. Enroll in courses to get started.</div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-header bg-primary text-white">
                    <h6>Selected Semester</h6>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(selectedSemester))
                    {
                        <div class="alert alert-info">
                            <h5>@selectedSemester</h5>
                            <p class="mb-0">You can now proceed to add courses for this semester.</p>
                        </div>
                        <button class="btn btn-lg btn-success w-100" @onclick="ConfirmSemester">
                            Proceed to Shopping Cart
                        </button>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            Please select a semester to continue.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int StudentId { get; set; }

    private List<string>? semesters;
    private string? selectedSemester = null;
    private bool useLinq = false;

    protected override void OnInitialized()
    {
        LoadSemesters();
    }

    private void LoadSemesters()
    {
        try
        {
            IZambeelService activeService = useLinq ? (IZambeelService)LINQ_Service : SP_Service;
            semesters = activeService.GetStudentSemesters(StudentId);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading semesters: {ex.Message}");
            semesters = new List<string>();
        }
    }

    private void SelectSemester(string semester)
    {
        selectedSemester = semester;
    }

    private void ConfirmSemester()
    {
        if (!string.IsNullOrEmpty(selectedSemester))
        {
            NavigationManager.NavigateTo($"/enroll/{StudentId}/shopping-cart?semester={Uri.EscapeDataString(selectedSemester)}");
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo($"/enroll/{StudentId}");
    }
}
